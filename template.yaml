AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31
Description: Example of processing messages on an SQS queue with Lambda
Resources:
  ProducerFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: app.handler
      CodeUri: src/producer
      Runtime: python3.8
      MemorySize: 1024 
      Timeout: 300  
      EphemeralStorage:
        Size: 1024
      Policies:
        - SQSSendMessagePolicy:
            QueueName: !GetAtt OriginalSearchesQueue.QueueName
        - S3ReadPolicy:
            BucketName: raw-data-amadeus
      Environment:
        Variables:
          QUEUE_URL: !GetAtt OriginalSearchesQueue.QueueUrl
          BUCKET_NAME: raw-data-amadeus
          FILE_KEY: raw-data-example.csv

  OriginalSearchesQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub "${AWS::StackName}-OriginalSearchesQueue"
    
  FilteredSearchesQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub "${AWS::StackName}-FilteredSearchesQueue"

  BackupStorageQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub "${AWS::StackName}-BackupStorageQueue"

  InitStackFunction:
    Type: AWS::Serverless::Function
    DependsOn: 
      - DecoratedSearchStorageNamespace
      - DecoratedSearchStorageWorkGroup
    Properties:
      Description: Initializes the Redshift database by creating the recommendations table
      CodeUri: src/init-stack-function
      Handler: app.lambda_handler
      Runtime: python3.12
      Environment:
        Variables:
          DB_NAME: !Sub "${AWS::StackName}-decorated-search-storage-db"
          WORKGROUP_NAME: !Sub "${AWS::StackName}-decorated-search-storage-wg"
      Policies: 
        - Version: '2012-10-17'
          Statement: 
            - Effect: Allow
              Resource: !GetAtt DecoratedSearchStorageWorkGroup.Workgroup.WorkgroupArn
              Action: 
                - redshift-data:ExecuteStatement
                - redshift-serverless:GetCredentials

  FilterLambdaFunction:
    Type: AWS::Serverless::Function
    DependsOn: 
      - OriginalSearchesQueue
      - FilteredSearchesQueue
      - BackupStorageQueue
      - CurrencyCacheTable
    Properties:
      CodeUri: src/filter-function
      Handler: app.lambda_handler
      Runtime: python3.12
      Timeout: 15
      Environment:
        Variables:
          OUTPUT_QUEUE_URL: !Sub "${FilteredSearchesQueue}"
          BACKUP_STORAGE_QUEUE_URL: !Sub "${BackupStorageQueue}"
          CURRENCY_CACHE_TABLE_NAME: !Ref CurrencyCacheTable
      Policies: 
        - SQSSendMessagePolicy:
            QueueName: !Ref FilteredSearchesQueue
        - SQSSendMessagePolicy:
            QueueName: !GetAtt FilteredSearchesQueue.QueueName
        - SQSSendMessagePolicy:
            QueueName: !Ref BackupStorageQueue
        - SQSSendMessagePolicy:
            QueueName: !GetAtt BackupStorageQueue.QueueName
        - DynamoDBCrudPolicy:
            TableName: !Ref CurrencyCacheTable
      Events:
        SQSEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt OriginalSearchesQueue.Arn
            BatchSize: 10
            Enabled: true

  BatchFunction:
    Type: AWS::Serverless::Function
    DependsOn: 
      - FilteredSearchesQueue
      - BatchBucket
    Properties:
      CodeUri: src/batch-function
      Handler: app.lambda_handler
      Runtime: python3.12
      Timeout: 15
      Environment:
        Variables:
          BUCKET_NAME: !Ref BatchBucket 
      Policies: 
        - S3WritePolicy:
            BucketName: !Ref BatchBucket
      Events:
        SQSEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt FilteredSearchesQueue.Arn
            BatchSize: 300
            MaximumBatchingWindowInSeconds: 60
            Enabled: true

  BatchBucket:
    Type: AWS::S3::Bucket
    Properties: 
      BucketName: !Sub "${AWS::StackName}-batch-bucket"

  StoreFunction:
    Type: AWS::Serverless::Function
    DependsOn: 
      - BatchBucket
      - DecoratedSearchStorageNamespace
      - DecoratedSearchStorageWorkGroup
    Properties:
      CodeUri: src/store-function
      Handler: app.lambda_handler
      Runtime: python3.12
      Timeout: 15
      Environment:
        Variables:
          DB_NAME: !Sub "${AWS::StackName}-decorated-search-storage-db"
          WORKGROUP_NAME: !Sub "${AWS::StackName}-decorated-search-storage-wg"
          BUCKET_NAME: !Ref BatchBucket
      Policies: 
        - S3ReadPolicy: # vraiment pas sur que cette permission soit n√©cessaire
            BucketName: !Ref BackupStorageBucket
        - Version: '2012-10-17'
          Statement: 
            - Effect: Allow
              Resource: !GetAtt DecoratedSearchStorageWorkGroup.Workgroup.WorkgroupArn
              Action: 
                - redshift-data:ExecuteStatement
                - redshift-serverless:GetCredentials
      # Events:
      #   ScheduleEvent:
      #     Type: Schedule
      #     Properties:
      #       Schedule: cron(* * * * ? *)
      #       Enabled: false
      Events:
        S3Event:
          Type: S3
          Properties:
            Bucket: !Ref BatchBucket
            Events: 
              - s3:ObjectCreated:*

  GetCurrencyFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/get-currency-function
      Handler: app.lambda_handler
      Runtime: python3.12
      Timeout: 15
      FunctionUrlConfig:
        AuthType: NONE
      Environment:
        Variables:
          CURRENCY_CACHE_TABLE: !Ref CurrencyCacheTable
          API_URL: https://data-api.ecb.europa.eu/service/data/EXR/D..EUR.SP00.A
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref CurrencyCacheTable
      Events:
        ScheduleEvent:
          Type: Schedule
          Properties:
            Schedule: cron(17 0 * * ? *)
            Enabled: false

  DecoratedSearchStorageNamespace:
    Type: AWS::RedshiftServerless::Namespace
    Properties:
      NamespaceName: !Sub "${AWS::StackName}-decorated-search-storage-ns"
      DbName: !Sub "${AWS::StackName}-decorated-search-storage-db"

  DecoratedSearchStorageWorkGroup:
    Type: AWS::RedshiftServerless::Workgroup
    Properties:
      WorkgroupName: !Sub "${AWS::StackName}-decorated-search-storage-wg"
      NamespaceName: !Ref DecoratedSearchStorageNamespace
      BaseCapacity: 32

  CurrencyCacheTable:
    Type: AWS::DynamoDB::Table
    Properties: 
      TableName: !Sub "${AWS::StackName}-currency-cache-table"
      AttributeDefinitions: 
        - AttributeName: dateISO
          AttributeType: S
        - AttributeName: currency_type
          AttributeType: S
        - AttributeName: exchange_rate
          AttributeType: N
      KeySchema: 
        - AttributeName: currency_type
          KeyType: HASH
        - AttributeName: dateISO
          KeyType: RANGE
      ProvisionedThroughput: 
        ReadCapacityUnits: 5
        WriteCapacityUnits: 5
      GlobalSecondaryIndexes: 
      - IndexName: myIndex
        KeySchema: 
          - AttributeName: exchange_rate
            KeyType: HASH
        Projection: 
          ProjectionType: KEYS_ONLY
        ProvisionedThroughput: 
          ReadCapacityUnits: 5
          WriteCapacityUnits: 5

  BackupStorageBucket:
    Type: AWS::S3::Bucket
    Properties: 
      BucketName: !Sub "${AWS::StackName}-backup-storage-bucket"
        
  BackupStorageFunction:
    Type: AWS::Serverless::Function
    DependsOn: 
      - BackupStorageQueue
      - BackupStorageBucket
    Properties:
      CodeUri: src/backup-function
      Handler: app.lambda_handler
      Runtime: python3.12
      Timeout: 15
      Environment:
        Variables:
          BUCKET_NAME: !Ref BackupStorageBucket
      Policies: 
        - S3WritePolicy:
            BucketName: !Ref BackupStorageBucket
      Events:
        SQSEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt BackupStorageQueue.Arn
            BatchSize: 10
            Enabled: true

#Outputs:
#  PublishMessageFunctionUrlEndpoint:
#      Description: "Publish Function URL Endpoint"
#      Value:
#        !GetAtt PublishMessageFunctionUrl.FunctionUrl
